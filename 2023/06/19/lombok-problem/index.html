<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Lombok 造成的翻车事故，太坑了！(转载) · 饼仔熊</title><meta name="description" content="Lombok 造成的翻车事故，太坑了！(转载) - 饼仔熊"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.jackyshao.cn/atom.xml" title="饼仔熊"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">饼仔熊</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>首页</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>归档</p></a><a href="/about" target="_self" class="li component-nav-item"><p>关于</p></a><ul class="shortcut-icons"><a href="https://github.com/shao113112" target="_blank"><img src="/images/github.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">Lombok 造成的翻车事故，太坑了！(转载)</h1><div class="post-info">2023年6月19日</div><div class="post-content"><h1 id="Setter-Getter方法的坑"><a href="#Setter-Getter方法的坑" class="headerlink" title="Setter-Getter方法的坑"></a>Setter-Getter方法的坑</h1><h2 id="问题发现"><a href="#问题发现" class="headerlink" title="问题发现"></a>问题发现</h2><h3 id="我们在项目当中主要使用Lombok的Setter-Getter方法的注解，也就是组合注解-Data，但是在一次使用Mybatis插入数据的过程当中，出现了一个问题，问题描述如下："><a href="#我们在项目当中主要使用Lombok的Setter-Getter方法的注解，也就是组合注解-Data，但是在一次使用Mybatis插入数据的过程当中，出现了一个问题，问题描述如下：" class="headerlink" title="我们在项目当中主要使用Lombok的Setter-Getter方法的注解，也就是组合注解@Data，但是在一次使用Mybatis插入数据的过程当中，出现了一个问题，问题描述如下："></a>我们在项目当中主要使用Lombok的Setter-Getter方法的注解，也就是组合注解@Data，但是在一次使用Mybatis插入数据的过程当中，出现了一个问题，问题描述如下：</h3><p>我们有个实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NMetaVerify</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> NMetaType nMetaType;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    ....其他属性</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们使用Mybatis插入数据的时候，发现，其他属性都能正常的插入，但是就是nMetaType属性在数据库一直是null。</p>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>当我debug项目代码到调用Mybatis的插入SQL对应的方法的时候，我看到NMetaVerify对象的nMetaType属性还是有数据的，但是执行插入之后，数据库的nMetaType字段就是一直是null，原先我以为是我的枚举类型写法不正确，看了下别的同样具有枚举类型的字段，也是正常能插入到数据库当中的，这更让我感觉到疑惑了。</p>
<p>于是，我就跟踪Mybatis的源码，发现Mybatis在获取这个nMetaType属性的时候使用了反射，使用的是getxxxx方法来获取的，但是我发现nMetaType的get方法好像有点和Mybatis需要的getxxxx方法长的好像不一样，问题找到了！</p>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>Lombok对于第一个字母小写，第二个字母大写的属性生成的get-set方法和Mybatis以及idea或者说是Java官方认可的get-set方法生成的不一样:</p>
<p>Lombok生成的Get-Set方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NMetaVerify</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> NMetaType nMetaType;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lombokFound</span><span class="params">()</span></span>&#123;</span><br><span class="line">        NMetaVerify nMetaVerify = <span class="keyword">new</span> NMetaVerify();</span><br><span class="line">        nMetaVerify.setNMetaType(NMetaType.TWO); <span class="comment">//注意：nMetaType的set方法为setNMetaType，第一个n字母大写了，</span></span><br><span class="line">        nMetaVerify.getNMetaType();              <span class="comment">//getxxxx方法也是大写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>idea，Mybatis，Java官方默认的行为为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NMetaVerify</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> NMetaType nMetaType;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NMetaType <span class="title">getnMetaType</span><span class="params">()</span> </span>&#123;<span class="comment">//注意：nMetaType属性的第一个字母小写</span></span><br><span class="line">        <span class="keyword">return</span> nMetaType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setnMetaType</span><span class="params">(NMetaType nMetaType)</span> </span>&#123;<span class="comment">//注意：nMetaType属性的第一个字母小写</span></span><br><span class="line">        <span class="keyword">this</span>.nMetaType = nMetaType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTime</span><span class="params">(Date createTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Mybatis-3-4-6版本-解析get-set方法获取属性名字的源码："><a href="#Mybatis-3-4-6版本-解析get-set方法获取属性名字的源码：" class="headerlink" title="Mybatis(3.4.6版本)解析get-set方法获取属性名字的源码："></a>Mybatis(3.4.6版本)解析get-set方法获取属性名字的源码：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.ibatis.reflection.property;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.ReflectionException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyNamer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="title">PropertyNamer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="comment">// Prevent Instantiation of Static Class</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">methodToProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (name.startsWith(<span class="string">"is"</span>)) &#123;<span class="comment">//is开头的一般是bool类型，直接从第二个(索引)开始截取(简单粗暴)</span></span><br><span class="line">          name = name.substring(<span class="number">2</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.startsWith(<span class="string">"get"</span>) || name.startsWith(<span class="string">"set"</span>)) &#123;<span class="comment">//set-get的就从第三个(索引)开始截取</span></span><br><span class="line">          name = name.substring(<span class="number">3</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> ReflectionException(<span class="string">"Error parsing property name '"</span> + name + <span class="string">"'.  Didn't start with 'is', 'get' or 'set'."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">            <span class="comment">//下面这个判断很重要，可以分成两句话开始解释，解释如下</span></span><br><span class="line">            <span class="comment">//第一句话：name.length()==1</span></span><br><span class="line">            <span class="comment">//       对于属性只有一个字母的，例如private int x;</span></span><br><span class="line">            <span class="comment">//          对应的get-set方法是getX();setX(int x);</span></span><br><span class="line">            <span class="comment">//第二句话：name.length() &gt; 1 &amp;&amp; !Character.isUpperCase(name.charAt(1)))</span></span><br><span class="line">            <span class="comment">//      属性名字长度大于1，并且第二个(代码中的charAt(1)，这个1是数组下标)字母是小写的</span></span><br><span class="line">            <span class="comment">//      如果第二个char是大写的，那就直接返回name</span></span><br><span class="line">      <span class="keyword">if</span> (name.length() == <span class="number">1</span> || (name.length() &gt; <span class="number">1</span> &amp;&amp; !Character.isUpperCase(name.charAt(<span class="number">1</span>)))) &#123;</span><br><span class="line">          name = name.substring(<span class="number">0</span>, <span class="number">1</span>).toLowerCase(Locale.ENGLISH) + name.substring(<span class="number">1</span>);<span class="comment">//让属性名第一个字母小写，然后加上后面的内容</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> name.startsWith(<span class="string">"get"</span>) || name.startsWith(<span class="string">"set"</span>) || name.startsWith(<span class="string">"is"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isGetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> name.startsWith(<span class="string">"get"</span>) || name.startsWith(<span class="string">"is"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSetter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> name.startsWith(<span class="string">"set"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Mybatis解析get-set方法为属性名字测试"><a href="#Mybatis解析get-set方法为属性名字测试" class="headerlink" title="Mybatis解析get-set方法为属性名字测试"></a>Mybatis解析get-set方法为属性名字测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">foundPropertyNamer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String isName = <span class="string">"isName"</span>;</span><br><span class="line">    String getName = <span class="string">"getName"</span>;</span><br><span class="line">    String getnMetaType = <span class="string">"getnMetaType"</span>;</span><br><span class="line">    String getNMetaType = <span class="string">"getNMetaType"</span>;</span><br><span class="line"></span><br><span class="line">    Stream.of(isName,getName,getnMetaType,getNMetaType)</span><br><span class="line">            .forEach(methodName-&gt;System.out.println(<span class="string">"方法名字是:"</span>+methodName+<span class="string">" 属性名字:"</span>+ PropertyNamer.methodToProperty(methodName)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">方法名字是:isName 属性名字:name </span><br><span class="line">   方法名字是:getName 属性名字:name </span><br><span class="line">   方法名字是:getnMetaType 属性名字:nMetaType <span class="comment">//这个以及下面的属性第二个字母都是大写，所以直接返回name</span></span><br><span class="line">   方法名字是:getNMetaType 属性名字:NMetaType</span><br></pre></td></tr></table></figure>

<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>修改属性名字，让第二个字母小写，或者说是规定所有的属性的前两个字母必须小写<br>如果数据库已经设计好，并且前后端接口对接好了，不想修改，那就专门为这种特殊的属性使用idea生成get-set方法复制代码</p>
<h1 id="Accessor-chain-true-注解的问题"><a href="#Accessor-chain-true-注解的问题" class="headerlink" title="@Accessor(chain = true)注解的问题"></a>@Accessor(chain = true)注解的问题</h1><h2 id="问题发现-1"><a href="#问题发现-1" class="headerlink" title="问题发现"></a>问题发现</h2><p>在使用 easyexcel 导出的时候，发现以前的实体类导出都很正常，但是现在新加的实体类不正常了，比对了发现，新加的实体类增加了@Accessor(chain = true)注解，我们的目的主要是方便我们链式调用set方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> UserDto()</span><br><span class="line">.setUserName(<span class="string">""</span>)</span><br><span class="line">.setAge(<span class="number">10</span>)</span><br><span class="line">........</span><br><span class="line">.setBirthday(<span class="keyword">new</span> Date());</span><br></pre></td></tr></table></figure>

<h2 id="原因-1"><a href="#原因-1" class="headerlink" title="原因"></a>原因</h2><p>easyexcel底层使用的是cglib来做反射工具包的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.excel.read.listener.ModelBuildEventListener 类的第<span class="number">130</span>行</span><br><span class="line">BeanMap.create(resultModel).putAll(map);</span><br><span class="line"></span><br><span class="line">最底层的是cglib的BeanMap的这个方法调用</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> Object <span class="title">put</span><span class="params">(Object bean, Object key, Object value)</span></span>;com.alibaba.excel.read.listener.ModelBuildEventListener 类的第<span class="number">130</span>行</span><br><span class="line">BeanMap.create(resultModel).putAll(map);</span><br><span class="line"></span><br><span class="line">最底层的是cglib的BeanMap的这个方法调用</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> Object <span class="title">put</span><span class="params">(Object bean, Object key, Object value)</span></span>;</span><br></pre></td></tr></table></figure>

<p>但是cglib使用的是Java的rt.jar里面的一个Introspector这个类的方法：</p>
<p>Introspector.java 第520行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">int</span>.class.equals(argTypes[<span class="number">0</span>]) &amp;&amp; name.startsWith(GET_PREFIX)) &#123;</span><br><span class="line">   pd = <span class="keyword">new</span> IndexedPropertyDescriptor(<span class="keyword">this</span>.beanClass, name.substring(<span class="number">3</span>), <span class="keyword">null</span>, <span class="keyword">null</span>, method, <span class="keyword">null</span>);</span><br><span class="line">   <span class="comment">//下面这行判断，只获取返回值是void类型的setxxxx方法</span></span><br><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">void</span>.class.equals(resultType) &amp;&amp; name.startsWith(SET_PREFIX)) &#123;</span><br><span class="line">    <span class="comment">// Simple setter</span></span><br><span class="line">    pd = <span class="keyword">new</span> PropertyDescriptor(<span class="keyword">this</span>.beanClass, name.substring(<span class="number">3</span>), <span class="keyword">null</span>, method);</span><br><span class="line">    <span class="keyword">if</span> (throwsException(method, PropertyVetoException.class)) &#123;</span><br><span class="line">       pd.setConstrained(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h2><p>去掉Accessor注解。</p>
<p>要么就等待easyexcel的作者替换掉底层的cglib或者是其他，反正是支持获取返回值不是void的setxxx方法就行复制代码。</p>
</div></article></div></div></main><footer class="footer-container"><div class="paginator"><a href="/2022/08/31/binary-decimal/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2023 <a href="https://www.jackyshao.cn">饼仔熊</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p><p><a href="https://beian.miit.gov.cn/" target="_blank">浙ICP备17048499号</a></p></div></footer></body></html>